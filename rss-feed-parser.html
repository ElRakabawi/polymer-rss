<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-ajax/core-ajax.html">

<polymer-element name="rss-feed-parser" constructor="RSSFeedParser" attributes="auto url headers params" hidden>

  <template>
    <core-ajax id="ajax" url="{{url}}" auto?="{{auto}}" body="{{body}}" headers="{{headers}}" on-core-response="{{handleResponse}}" handleAs="xml">
  </template>

  <script>
    Polymer('rss-feed-parser', {
      auto: false,
      handleResponse: function(event) {
        var response = event.detail.response;
        if(!response.querySelector('rss')) {
          this.fire('invalid-feed', {response: response, xhr: event.detail.xhr});
        }else {
          var channel = response.querySelector('rss channel');
          var feed = this.parseChannel(channel);
          console.log(feed);
          this.fire('feed-parsed', { feed: feed, response: response, xhr: event.detail.xhr} );
        }
      },
      go: function() {
        this.$.ajax.go();
      },
      parseChannel: function(channel) {
        var feed = {};
        feed.title = this.parseElement(channel, 'title');
        feed.description = this.parseElement(channel, 'description');
        feed.link = this.parseElement(channel, 'link');
        feed.language = this.parseElement(channel, 'language');
        feed.copyright = this.parseElement(channel, 'copyright');
        feed.managingEditor = this.parseElement(channel, 'managingEditor');
        feed.webMaster = this.parseElement(channel, 'webMaster');
        feed.pubDate = this.parseElement(channel, 'pubDate', this.dateCallback);
        feed.lastBuildDate = this.parseElement(channel, 'lastBuildDate', this.dateCallback);
        feed.generator = this.parseElement(channel, 'generator');
        feed.docs = this.parseElement(channel, 'docs');
        feed.cloud = this.parseElement(channel, 'cloud', this.cloudCallback);
        feed.ttl = this.parseElement(channel, 'ttl');
        // feed.image = this.parseElement(image, 'image');

        return feed;
      },
      parseElement: function(channel, string, cb) {
        if(!cb) {
          cb = this.textCallback;
        }
        var item = channel.querySelector(string);
        if(item){
          return cb(item);
        }
      },
      textCallback: function(item) {
        return item.textContent;
      },
      dateCallback: function(item) {
        return new Date(item.textContent)
      },
      cloudCallback: function(item) {
        var cloud = {};
        cloud.domain = item.domain;
        cloud.port = item.port;
        cloud.path = item.path;
        cloud.registerProcedure  = item.registerPrucedure;
        cloud.protocol = item.protocol;
        return cloud;
      }
    });
  </script>
</polymer-element>
